<!DOCTYPE html>
<html>
<head>
    <title>照片分享</title>
    <style>
        body {
            background-color: #f5f5f5;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        h1 {
            text-align: center;
            padding: 20px 0;
            color: #333;
        }

        .gallery {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }

        .image-container {
            text-align: center;
            margin: 20px;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.3s ease;
            border-radius: 4px;
            overflow: hidden;
        }

        .image-container:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .image-container img {
            display: block;
            width: 100%;
            height: auto;
            object-fit: cover;
        }

        .exif-info {
            padding: 10px;
            font-size: 14px;
            color: #666;
            text-align: left;
            background-color: #f5f5f5;
            border-top: 1px solid #ddd;
        }

        .exif-info p {
            margin: 5px 0;
        }

        .exif-info p .label {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>照片分享</h1>

    <div class="gallery"></div>

    <script src="exif.js"></script>
    <script>
        var imageFolder = 'images/';
        var imagesPerLoad = 20;
        var scrollThreshold = 200;
        var startIndex = 0;

        function loadImage(imageIndex) {
            return new Promise(function(resolve, reject) {
                var img = new Image();
                img.onload = function() {
                    resolve(img);
                };
                img.onerror = function() {
                    reject();
                };
                img.src = imageFolder + 'image' + imageIndex + '.jpg';
            });
        }

        function loadImages(start, count) {
            var gallery = document.querySelector('.gallery');

            var loadPromises = [];
            for (var i = start; i < start + count; i++) {
                var imageIndex = padDigits(i, 2);

                var loadPromise = loadImage(imageIndex).then(function(img) {
                    var imageContainer = document.createElement('div');
                    imageContainer.className = 'image-container';

                    var image = document.createElement('img');
                    image.src = img.src;
                    imageContainer.appendChild(image);

                    getExifInformation(img, imageContainer);

                    gallery.appendChild(imageContainer);
                }).catch(function() {
                    console.log('Failed to load image: image' + imageIndex + '.jpg');
                });

                loadPromises.push(loadPromise);
            }

            Promise.all(loadPromises).then(function() {
                sortImagesByExifDateTime();
            });
        }

        function getExifInformation(image, element) {
            EXIF.getData(image, function() {
                var exifInfo = document.createElement('div');
                exifInfo.className = 'exif-info';

                var exifData = EXIF.getAllTags(this);
                if (exifData) {
                    var exifHtml = '';

                    if (exifData.DateTimeOriginal) {
                        var dateTaken = parseExifDateTime(exifData.DateTimeOriginal);
                        exifHtml += '<p><span class="label">拍摄时间:</span> ' + formatDate(dateTaken) + '</p>';
                    }

                    exifHtml += '<p><span class="label">经度:</span> ' + (exifData.GPSLongitude || 'N/A') + '</p>';
                    exifHtml += '<p><span class="label">纬度:</span> ' + (exifData.GPSLatitude || 'N/A') + '</p>';
                    exifHtml += '<p><span class="label">光圈:</span> ' + (exifData.FNumber || 'N/A') + '</p>';
                    exifHtml += '<p><span class="label">焦距:</span> ' + (exifData.FocalLength || 'N/A') + '</p>';
                    exifHtml += '<p><span class="label">相机型号:</span> ' + (exifData.Model || 'N/A') + '</p>';

                    exifInfo.innerHTML = exifHtml;
                } else {
                    exifInfo.innerHTML = '<p>No Exif data available</p>';
                }

                element.appendChild(exifInfo);
            });
        }

        function parseExifDateTime(dateTimeString) {
            var dateTimeParts = dateTimeString.split(' ');
            var dateParts = dateTimeParts[0].split(':');
            var timeParts = dateTimeParts[1].split(':');

            var year = parseInt(dateParts[0]);
            var month = parseInt(dateParts[1]) - 1;
            var day = parseInt(dateParts[2]);
            var hour = parseInt(timeParts[0]);
            var minute = parseInt(timeParts[1]);
            var second = parseInt(timeParts[2]);

            return new Date(year, month, day, hour, minute, second);
        }

        function formatDate(date) {
            var options = { year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        function padDigits(number, digits) {
            return Array(Math.max(digits - String(number).length + 1, 0)).join('0') + number;
        }

        function sortImagesByExifDateTime() {
            var imageContainers = Array.from(document.querySelectorAll('.image-container'));

            imageContainers.sort(function(a, b) {
                var dateTimeA = parseExifDateTime(a.querySelector('.exif-info .date-taken').textContent);
                var dateTimeB = parseExifDateTime(b.querySelector('.exif-info .date-taken').textContent);

                return dateTimeB - dateTimeA;
            });

            var gallery = document.querySelector('.gallery');
            imageContainers.forEach(function(container) {
                gallery.appendChild(container);
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadImages(startIndex, imagesPerLoad);

            window.addEventListener('scroll', function() {
                var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
                var windowHeight = window.innerHeight || document.documentElement.clientHeight;
                var documentHeight = document.documentElement.scrollHeight;

                if (documentHeight - scrollTop - windowHeight < scrollThreshold) {
                    startIndex += imagesPerLoad;
                    loadImages(startIndex, imagesPerLoad);
                }
            });
        });
    </script>
</body>
</html>
